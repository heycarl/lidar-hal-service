name: Build ARM64 offline deb

on:
  push:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-24.04-arm

    env:
      PKG_NAME: lidar-service

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install build dependencies
        run: |
          sudo apt update
          sudo apt install -y dpkg-dev python3.12-venv python3.12-distutils build-essential

      - name: Extract metadata from pyproject.toml
        id: meta
        run: |
          python - << 'EOF'
          import tomllib, os
          p = tomllib.load(open("pyproject.toml","rb"))["project"]
          os.environ["VERSION"] = p["version"]
          os.environ["DESCRIPTION"] = p.get("description","")
          author = p["authors"][0]
          os.environ["MAINTAINER"] = f'{author["name"]} <{author["email"]}>'
          print(f'Version: {os.environ["VERSION"]}')
          EOF
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
          echo "DESCRIPTION=${DESCRIPTION}" >> $GITHUB_ENV
          echo "MAINTAINER=${MAINTAINER}" >> $GITHUB_ENV

      - name: Build wheel packages
        run: |
          python3 -m pip install --upgrade pip wheel
          python3 -m pip wheel . -w packaging/wheels

      - name: Prepare package layout
        run: |
          mkdir -p pkg/opt/${PKG_NAME}/{app,config,wheels,bin}
          mkdir -p pkg/lib/systemd/system
          mkdir -p pkg/DEBIAN

          cp -r src pkg/opt/${PKG_NAME}/app/
          cp config.yaml pkg/opt/${PKG_NAME}/config/
          cp -r packaging/wheels/* pkg/opt/${PKG_NAME}/wheels/
          cp packaging/bin/${PKG_NAME} pkg/opt/${PKG_NAME}/bin/
          cp packaging/systemd/${PKG_NAME}.service pkg/lib/systemd/system/

          sed \
            -e "s/@NAME@/${PKG_NAME}/" \
            -e "s/@VERSION@/${VERSION}/" \
            -e "s/@DESCRIPTION@/${DESCRIPTION}/" \
            -e "s/@MAINTAINER@/${MAINTAINER}/" \
            packaging/DEBIAN/control.in > pkg/DEBIAN/control

          cp packaging/DEBIAN/postinst pkg/DEBIAN/
          chmod 755 pkg/DEBIAN/postinst

      - name: Build deb package
        run: dpkg-deb --build pkg ${PKG_NAME}_${VERSION}_arm64.deb

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${PKG_NAME}-deb
          path: "*.deb"
